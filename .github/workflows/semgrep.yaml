on:
  workflow_dispatch: {}
  push:
    branches:
    - main
    paths:
    - .github/workflows/semgrep.yml
name: Semgrep Findings
jobs:
  semgrep-sast:
    name: Semgrep-SAST
    runs-on: ubuntu-20.04
    container:
      image: semgrep/semgrep
    steps:
    - uses: actions/checkout@v4
    - name: Semgrep scan
      run: |
        # Run Semgrep scan and store the output in JSON
        semgrep scan --json --json-output /tmp/semgrep.json
      env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}

    - name: View the output
      run: |
        ls -la /tmp
        cat /tmp/semgrep.json

    - name: Upload report to AccuKnox
      run: |
        curl --location --request POST \
        "https://cspm.stage.accuknox.com/api/v1/artifact/?tenant_id=4&data_type=SG&save_to_s3=true&label_id=semgrep" \
              --header "Tenant-Id: 4" \
              --header "Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJ0b2tlbl90eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzQxODU2OTU4LCJqdGkiOiJiNzNlNjE3N2ExYmM0NmNlYjMyN2RiMzBlY2E0MjM2YiIsImlzcyI6ImNzcG0uc3RhZ2UuYWNjdWtub3guY29tIn0.PocZyOUZZQzWuYfiZ9PdtQzjQlKn53l2PAIkHy5esViChLrUva0eoUhKajoyQiwgjAKzbDa1O-jAsemvZSPRfAPaFhOykr3NndrfRTiJKPzQxL0wa-iOJ0Z37LJ69DXMogssSFyyPbEoiUAePgFJwKYukhnO7KDTb-fnilPD2_OrJAJq85jnS-3UwUvUVLMWrHBSlwkP7Shi75kvKMXnn2VtWmg6rWmvYAOeh7wbmcWT_zp8ci8t1_Dzq7oa81z-ODsh01DLxO01EzRwT2deVso5s8TfQP4Lb4bkKQftVEjLQaQOblCKS8ZmWyQwLRENYYCVbpW_tzM3kjmqQXVrMQ" \
              --form "file=@/tmp/semgrep.json"

    # - name: Upload report to AccuKnox
    #   run: |
    #     curl --location --request POST \
    #     "https://cspm.stage.accuknox.com/api/v1/artifact/?tenant_id=${{ secrets.ACCUKNOX_TENANT_ID }}&data_type=SG&save_to_s3=true&label_id=${{ secrets.ACCUKNOX_LABEL }}" \
    #           --header "Tenant-Id: {{ secrets.ACCUKNOX_TENANT_ID }}" \
    #           --header "Authorization: Bearer {{ secrets.ACCUKNOX_TOKEN }}" \
    #           --form "file=@/tmp/semgrep.json"